{% extends 'base.html' %}
{% block content %}

{% if object %}
    <h1>Edit <span class="teal-text">{{ object.title }}</span> </h1>
{% else %}
    <h1>Add Sighting</h1>
{% endif %}

<form action="" method="post">
    {% csrf_token %}
    <table>
        {{ form.as_table }}
    </table>
    <input type="submit" value="Submit!" class="btn">
</form>

<!-- Ale to delete everything in script tags once we remove materialize -->
<script>
    var dateEl = document.getElementById('id_date');
    M.Datepicker.init(dateEl, {
      format: 'yyyy-mm-dd',
      defaultDate: new Date(),
      setDefaultDate: true,
      autoClose: true
    });
    var selectEl = document.getElementById('id_species');
    M.FormSelect.init(selectEl);
</script>
<div>
<h3>Click the map below for latitude & longitude:</h3>
<style>
    #map {
        height:400px;
        width:400px;
    }
</style>

<div>
    <input id="address" type="textbox" onfocus="this.value=''" value="Enter Your Location" />
    <input id="submit" type ="button" value="Search" />
</div>

    <div id="map"></div>
</div>

<script>
    let map, infoWindowLatLng, geocoder;
    let myLatLng = {lat:39.9612,lng:-82.9988};
    function initMap(){
        var options = {
            zoom: 8,
            center: myLatLng
        };
        
        map = new google.maps.Map(document.getElementById('map'), options);
        infoWindow = new google.maps.InfoWindow();
        geocoder = new google.maps.Geocoder();
        infoWindowLatLng = new google.maps.InfoWindow(
            {content: "Click the map to get Lat/Lng!", position: myLatLng}
        );
        infoWindowLatLng.open(map);      
        map.addListener('click', function(event) {
            infoWindowLatLng.close()
            infoWindowLatLng = new google.maps.InfoWindow({position: event.latLng});
            var latLngStr = event.latLng.toString()
            infoWindowLatLng.setContent(latLngStr);
            infoWindowLatLng.open(map);
            newLaLn = latLngStr.replace('(','').replace(')','')
            arrLaLn = newLaLn.split(',')
            sLat = parseFloat(arrLaLn[0]).toFixed(9)
            sLng = parseFloat(arrLaLn[1]).toFixed(9)
            document.getElementById("id_latitude").value = sLat
            document.getElementById("id_longitude").value = sLng
    
            geocoder.geocode({
                'latLng': event.latLng
                }, 
                function(results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                    if (results[0]) {
                        var addStr = results[0].formatted_address;
                        document.getElementById("id_location").value = addStr;
                    }
                }
            });
        });
    }
    
    findGeoLoc();
    
    document.getElementById("submit").addEventListener("click", () => {
        geocodeAddress(geocoder, map);
    });
    
    document.getElementById("address").addEventListener("keyup", function(event) {
        if (event.keyCode === 13) {
            event.preventDefault();
            document.getElementById("submit").click();
        }
    });

    function findGeoLoc() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                position => {
                    const myLatLng = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    infoWindow.setPosition(myLatLng);
                    infoWindow.setContent("Location found. Click the map to get Lat/Lng!");
                    infoWindow.open(map)
                    map.setCenter(myLatLng);
                },
                () => {
                    handleLocationError(true, infowWindow, map.getCenter());
                }
            );
        } else {
            handleLocationError(false, infoWindow, map.getCenter());
        }
    }

    function geocodeAddress(geocoder, resultsMap) {
        const address = document.getElementById("address").value;
        geocoder.geocode({ address: address }, ( results, status ) => {
            if (status === "OK") {
                resultsMap.setCenter(results[0].geometry.location);
            } else {
                alert("Geocode was not successful for the following reason: " + status);
            }
        });
    }
</script>
<script defer
    src="https://maps.googleapis.com/maps/api/js?key={{GOOGLE_API_KEY}}&callback=initMap">
</script>

{% endblock %}