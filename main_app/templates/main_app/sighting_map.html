{% extends 'base.html' %}
{% block content %}

<h1 id="map-header">Find Sightings Near You!</h1>
<style>
    #map {
        height:480px;
        width:800px;
        margin-left: 20rem;
        box-shadow: 0 0 1rem #c0fdff;
        padding-top: 3rem;
    }
</style>

    <input id="address" class="location-input" type="textbox" onfocus="this.value=''" value="Enter Your Location" />
    <input id="search"  class="map-submit" type ="button" value="Search" />
    <input id="generate" type ="button" value="Generate" />


<div id="map"></div>

<script>
    var input = document.getElementById("address");
    input.addEventListener("keyup", function(event) {
        if (event.keyCode === 13) {
            event.preventDefault();
            document.getElementById("search").click();
        }
    });
</script>

<script>
    {% autoescape off %}
    var sightings_list = {{ sightings }}
    {% endautoescape %}
</script>

<script>
    let map, infoWindow, myLatLng, searchLat, searchLng, api_sightings_list;
    let activeInfoWindow = null;

    function initMap(){

        myLatLng = {lat:39.9612,lng:-82.9988}
        searchLat = 39.9612
        searchLng = -82.9988

        var options = {
            zoom:8,
            center: myLatLng
        };
        
        map = new google.maps.Map(document.getElementById('map'), options);
        infoWindow = new google.maps.InfoWindow();

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                position => {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    infoWindow.setPosition(pos);
                    infoWindow.setContent("Location found.");
                    infoWindow.open(map)
                    map.setCenter(pos);
                },
                () => {
                    handleLocationError(true, infowWindow, map.getCenter());
                }
            );
        } else {
            handleLocationError(false, infoWindow, map.getCenter());
        }

        const geocoder = new google.maps.Geocoder();
        document.getElementById("search").addEventListener("click", () => {
            geocodeAddress(geocoder, map);
        });

        
        

        for(var i=0; i < sightings_list.length; i++){
            addMarker(sightings_list[i]);
        }

        function addMarker(props){
            var x = parseFloat(props.lat)
            var y = parseFloat(props.lng)
            var marker = new google.maps.Marker({
            position: { lat: x, lng: y },
            map: map,
        });

        if(props.title){
            var tStr = "<div style='float:right; padding: 10px;'><h4>" + String(props.title) + "<h4></div>"
            var sUrl = props.url
            var sImg = "<div style='float:left;'><img height='100' width='100' src='" + props.url + "'></div>"
            var infoWindowSighting = new google.maps.InfoWindow({
            content: sImg + tStr
        });

        marker.addListener('click', function(){
            if (activeInfoWindow != null) { activeInfoWindow.close(); }
            infoWindowSighting.open(map, marker);
            activeInfoWindow = infoWindowSighting;
        });
        }
        }
    }

    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(
            browserHasGeolocation
            ? "Error: The Geolocation service failed."
            : "Error: Your browser doesn't support geolocation."
        );
        infoWindow.open(map);
    }

    function geocodeAddress(geocoder, resultsMap) {
        const address = document.getElementById("address").value;
        geocoder.geocode({ address: address }, ( results, status ) => {
            if (status === "OK") {
                myLatLng = results[0].geometry.location;
                resultsMap.setCenter(myLatLng);
            
                var latLngStr = myLatLng.toString();
                newLatLng = latLngStr.replace('(','').replace(')','')
                arrLatLng = newLatLng.split(',')
                searchLat = parseFloat(arrLatLng[0]).toFixed(9)
                searchLng = parseFloat(arrLatLng[1]).toFixed(9)

            } else {
                alert("Geocode was not successful for the following reason: " + status);
            }
        });
    }

</script>

<script>
    // function that fetches response from backend
    function whaleAPI(lat, lng) {
        searchURL = "api.json?near=" + lat + "," + lng + "&radius=100"
        return fetch("/generate/" + searchURL, {
            method: "GET",
            headers: new Headers({ "Content-Type": "application/json" }),
        }).then(res => {
            // if (res.ok) return res.json();
            // throw new Error('Search invalid');
            return res.json()
        }).catch(error => console.log(error))
    }

    // function that awaits for response
    async function handleGenerate(lat, lng) {
        const response = await whaleAPI(lat, lng);
        api_sightings_list = response.items;
    }

    // event listener for click on 'generate' button that uses searchLat and searchLng
    document.getElementById("generate").addEventListener("click", () => {
        handleGenerate(searchLat, searchLng)
    })
</script>

<script defer
    src="https://maps.googleapis.com/maps/api/js?key={{GOOGLE_API_KEY}}&callback=initMap">
</script>

{% endblock %}