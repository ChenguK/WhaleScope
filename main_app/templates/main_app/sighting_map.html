{% extends 'base.html' %}
{% block content %}

<h1 id="map-header">Find Sightings Near You!</h1>
<style>
    #map {
        height:480px;
        width:800px;
        margin-left: 20rem;
        box-shadow: 0 0 1rem #c0fdff;
        padding-top: 3rem;
    }
</style>

    <input id="address" class="location-input" type="textbox" onfocus="this.value=''" value="Enter Your Location" />
    <input id="submit"  class="map-submit" type ="button" value="Search" />

<div id="map"></div>

<script>
    var input = document.getElementById("address");
    input.addEventListener("keyup", function(event) {
        if (event.keyCode === 13) {
            event.preventDefault();
            document.getElementById("submit").click();
        }
    });
</script>

<script>
    {% autoescape off %}
    var sightings_list = {{ sightings }}
    {% endautoescape %}
</script>

<script>
    let map, infoWindow, myLatLng, searchLat, searchLng;
    let activeInfoWindow = null;

    function initMap(){

        myLatLng = {lat:34.0522,lng:-118.2437}

        var options = {
            zoom:8,
            center: myLatLng
        };
        
        map = new google.maps.Map(document.getElementById('map'), options);
        infoWindow = new google.maps.InfoWindow();

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                position => {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    infoWindow.setPosition(pos);
                    infoWindow.setContent("Location found.");
                    infoWindow.open(map)
                    map.setCenter(pos);
                },
                () => {
                    handleLocationError(true, infowWindow, map.getCenter());
                }
            );
        } else {
            handleLocationError(false, infoWindow, map.getCenter());
        }

        const geocoder = new google.maps.Geocoder();
        document.getElementById("submit").addEventListener("click", () => {
            geocodeAddress(geocoder, map);
        });

        for(var i=0; i < sightings_list.length; i++){
            addMarker(sightings_list[i]);
        }

        function addMarker(props){
            var x = parseFloat(props.lat)
            var y = parseFloat(props.lng)
            var marker = new google.maps.Marker({
            position: { lat: x, lng: y },
            map: map,
        });

        if(props.title){
            var tStr = "<div style='float:right; padding: 10px;'><h4>" + String(props.title) + "<h4></div>"
            var sUrl = props.url
            var sImg = "<div style='float:left;'><img height='100' width='100' src='" + props.url + "'></div>"
            var infoWindowSighting = new google.maps.InfoWindow({
            content: sImg + tStr
        });

        marker.addListener('click', function(){
            if (activeInfoWindow != null) { activeInfoWindow.close(); }
            infoWindowSighting.open(map, marker);
            activeInfoWindow = infoWindowSighting;
        });
        }
        }
    }

    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(
            browserHasGeolocation
            ? "Error: The Geolocation service failed."
            : "Error: Your browser doesn't support geolocation."
        );
        infoWindow.open(map);
    }

    function geocodeAddress(geocoder, resultsMap) {
        const address = document.getElementById("address").value;
        geocoder.geocode({ address: address }, ( results, status ) => {
            if (status === "OK") {
                myLatLng = results[0].geometry.location;
                resultsMap.setCenter(myLatLng);
            
                var latLngStr = myLatLng.toString();
                newLatLng = latLngStr.replace('(','').replace(')','')
                arrLatLng = newLatLng.split(',')
                searchLat = parseFloat(arrLatLng[0]).toFixed(9)
                searchLng = parseFloat(arrLatLng[1]).toFixed(9)

            } else {
                alert("Geocode was not successful for the following reason: " + status);
            }
        });
    }

</script>
<script defer
    src="https://maps.googleapis.com/maps/api/js?key={{GOOGLE_API_KEY}}&callback=initMap">
</script>

{% endblock %}